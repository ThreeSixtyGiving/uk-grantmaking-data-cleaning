# Generated by Django 5.2.8 on 2026-02-16 17:01

import django_db_views.migration_functions
import django_db_views.operations
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("ukgrantmaking", "0137_funder_ctry_rgn_aoo_manual"),
    ]

    operations = [
        django_db_views.operations.ViewRunPython(
            code=django_db_views.migration_functions.DropView(
                "ukgrantmaking_funders_regional_view",
                engine="django.db.backends.postgresql",
            ),
            reverse_code=django_db_views.migration_functions.BackwardViewMigration(
                'WITH base AS (\n            SELECT org_id,\n                "name",\n                segment,\n                category,\n                "scale",\n                f."year1_Grantmaking_GBP_m" AS "grantmaking",\n                "scale" ILIKE \'%%overseas%%\' AS "overseas",\n                ctry_aoo::jsonb ? \'E92000001\' AS "england",\n                ctry_aoo::jsonb ? \'N92000002\' AS "northern_ireland",\n                ctry_aoo::jsonb ? \'S92000003\' AS "scotland",\n                ctry_aoo::jsonb ? \'W92000004\' AS "wales",\n                rgn_aoo::jsonb ? \'E12000001\' AS "england_northeast",\n                rgn_aoo::jsonb ? \'E12000002\' AS "england_northwest",\n                rgn_aoo::jsonb ? \'E12000003\' AS "england_yorkshire",\n                rgn_aoo::jsonb ? \'E12000004\' AS "england_eastmidlands",\n                rgn_aoo::jsonb ? \'E12000005\' AS "england_westmidlands",\n                rgn_aoo::jsonb ? \'E12000006\' AS "england_east",\n                rgn_aoo::jsonb ? \'E12000007\' AS "england_london",\n                rgn_aoo::jsonb ? \'E12000008\' AS "england_southeast",\n                rgn_aoo::jsonb ? \'E12000009\' AS "england_southwest"\n            FROM ukgrantmaking_funders_analysis_view f\n            ORDER BY f."year1_Grantmaking_Rank"\n        )\n        SELECT org_id,\n            "name",\n            segment,\n            category,\n            "scale",\n            grantmaking,\n            CASE WHEN "scale" IN (\'National and Overseas\', \'Overseas\') THEN "scale"\n                WHEN "scale" = \'National\' THEN \n                    CASE WHEN "england" AND "northern_ireland" AND "scotland" AND "wales" THEN \'United Kingdom\'\n                        WHEN "england" AND "scotland" AND "wales" THEN \'Great Britain\'\n                        WHEN "england" AND "wales" THEN \'England and Wales\'\n                        WHEN "england" THEN \'England\'\n                        WHEN "wales" THEN \'Wales\'\n                        WHEN "scotland" THEN \'Scotland\'\n                        WHEN "northern_ireland" THEN \'Northern Ireland\'\n                        ELSE \'Other National\' END\n                WHEN "scale" = \'Regional\' THEN \'Regional\'\n                WHEN "scale" = \'Local\' THEN \'Local\'\n                ELSE \'Other\' END AS "geoarea",\n            "overseas",\n            "england",\n            "northern_ireland",\n            "scotland",\n            "wales",\n            "england_northeast",\n            "england_northwest",\n            "england_yorkshire",\n            "england_eastmidlands",\n            "england_westmidlands",\n            "england_east",\n            "england_london",\n            "england_southeast",\n            "england_southwest"\n        FROM base\n        ORDER BY grantmaking DESC NULLS LAST',
                "ukgrantmaking_funders_regional_view",
                engine="django.db.backends.postgresql",
            ),
            atomic=False,
        ),
        django_db_views.operations.ViewRunPython(
            code=django_db_views.migration_functions.ForwardViewMigration(
                "WITH ufv AS (\n        SELECT \n            segment,\n            category,\n            org_id,\n            name,\n            fy,\n            tags_list_year,\n            financial_year_end,\n            spending_grant_making,\n            spending_grant_making_individuals,\n            income,\n            spending,\n            total_net_assets,\n            employees,\n            makes_grants_to_individuals,\n            -- Convert key metrics to millions\n            spending_grant_making / 1000000.0 AS grantmaking_m,\n            spending_grant_making_individuals / 1000000.0 AS grantmaking_individuals_m,\n            income / 1000000.0 AS income_m,\n            spending / 1000000.0 AS spending_m,\n            total_net_assets / 1000000.0 AS net_assets_m,\n            -- Define grantmaking bands\n            CASE \n                WHEN spending_grant_making IS NULL OR spending_grant_making = 0 \n                THEN 'Zero/Unknown Spend'\n                WHEN spending_grant_making > 0 AND spending_grant_making < 100000 \n                THEN 'Under £100k'\n                WHEN spending_grant_making >= 100000 AND spending_grant_making <= 1000000 \n                THEN '£100k-£1m'\n                WHEN spending_grant_making > 1000000 AND spending_grant_making <= 10000000 \n                THEN '£1m-£10m'\n                WHEN spending_grant_making > 10000000 AND spending_grant_making <= 100000000 \n                THEN '£10m-£100m'\n                WHEN spending_grant_making > 100000000 \n                THEN 'Over £100m'\n            END AS grantmaking_band\n        FROM ukgrantmaking_funders_view\n        ),\n        -- Add country / region details based on AOO and manual overrides\n        ctryrgn_a AS (\n            SELECT org_id,\n                to_jsonb(\n                    array_remove(\n                        ARRAY[\n                            CASE WHEN ctry_rgn_aoo_manual->'E92000001' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.E92000001' RETURNING BOOLEAN ) THEN 'E92000001' ELSE NULL END\n                                WHEN ctry_aoo ? 'E92000001' THEN 'E92000001' END,\n                            CASE WHEN ctry_rgn_aoo_manual->'N92000002' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.N92000002' RETURNING BOOLEAN ) THEN 'N92000002' ELSE NULL END\n                                WHEN ctry_aoo ? 'N92000002' THEN 'N92000002' END,\n                            CASE WHEN ctry_rgn_aoo_manual->'S92000003' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.S92000003' RETURNING BOOLEAN ) THEN 'S92000003' ELSE NULL END\n                                WHEN ctry_aoo ? 'S92000003' THEN 'S92000003' END,\n                            CASE WHEN ctry_rgn_aoo_manual->'W92000004' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.W92000004' RETURNING BOOLEAN ) THEN 'W92000004' ELSE NULL END\n                                WHEN ctry_aoo ? 'W92000004' THEN 'W92000004' END\n                        ],\n                        NULL\n                    )\n                ) AS ctry_aoo,\n                to_jsonb(\n                    array_remove(\n                        ARRAY[\n                            CASE WHEN ctry_rgn_aoo_manual->'E12000001' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.E12000001' RETURNING BOOLEAN ) THEN 'E12000001' ELSE NULL END\n                                WHEN rgn_aoo ? 'E12000001' THEN 'E12000001' END,\n                            CASE WHEN ctry_rgn_aoo_manual->'E12000002' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.E12000002' RETURNING BOOLEAN ) THEN 'E12000002' ELSE NULL END\n                                WHEN rgn_aoo ? 'E12000002' THEN 'E12000002' END,\n                            CASE WHEN ctry_rgn_aoo_manual->'E12000003' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.E12000003' RETURNING BOOLEAN ) THEN 'E12000003' ELSE NULL END\n                                WHEN rgn_aoo ? 'E12000003' THEN 'E12000003' END,\n                            CASE WHEN ctry_rgn_aoo_manual->'E12000004' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.E12000004' RETURNING BOOLEAN ) THEN 'E12000004' ELSE NULL END\n                                WHEN rgn_aoo ? 'E12000004' THEN 'E12000004' END,\n                            CASE WHEN ctry_rgn_aoo_manual->'E12000005' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.E12000005' RETURNING BOOLEAN ) THEN 'E12000005' ELSE NULL END\n                                WHEN rgn_aoo ? 'E12000005' THEN 'E12000005' END,\n                            CASE WHEN ctry_rgn_aoo_manual->'E12000006' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.E12000006' RETURNING BOOLEAN ) THEN 'E12000006' ELSE NULL END\n                                WHEN rgn_aoo ? 'E12000006' THEN 'E12000006' END,\n                            CASE WHEN ctry_rgn_aoo_manual->'E12000007' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.E12000007' RETURNING BOOLEAN ) THEN 'E12000007' ELSE NULL END\n                                WHEN rgn_aoo ? 'E12000007' THEN 'E12000007' END,\n                            CASE WHEN ctry_rgn_aoo_manual->'E12000008' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.E12000008' RETURNING BOOLEAN ) THEN 'E12000008' ELSE NULL END\n                                WHEN rgn_aoo ? 'E12000008' THEN 'E12000008' END,\n                            CASE WHEN ctry_rgn_aoo_manual->'E12000009' IS NOT NULL \n                                THEN CASE WHEN JSON_VALUE(ctry_rgn_aoo_manual, '$.E12000009' RETURNING BOOLEAN ) THEN 'E12000009' ELSE NULL END\n                                WHEN rgn_aoo ? 'E12000009' THEN 'E12000009' END\n                        ],\n                        NULL\n                    )\n                ) AS rgn_aoo\n            FROM ukgrantmaking_funder\n        ),\n        -- add funder regulator details from funder table\n        funder_details AS (\n            SELECT\n                f.org_id,\n                f.charity_number,\n                f.active,\n                f.date_of_registration,\n                f.how,\n                f.what,\n                f.who,\n                f.scale,\n                f.postcode,\n                -- HQ\n                f.la_hq,\n                f.la_hq_name,\n                f.rgn_hq,\n                f.rgn_hq_name,\n                f.ctry_hq,\n                f.ctry_hq_name,\n                -- AOO\n                f.la_aoo,\n                f.la_aoo_name,\n                ctryrgn_a.rgn_aoo,\n                jsonb_strip_nulls(jsonb_build_object(\n                    'E12000001', CASE WHEN ctryrgn_a.rgn_aoo ? 'E12000001' THEN 'North East' ELSE NULL END,\n                    'E12000002', CASE WHEN ctryrgn_a.rgn_aoo ? 'E12000002' THEN 'North West' ELSE NULL END,\n                    'E12000003', CASE WHEN ctryrgn_a.rgn_aoo ? 'E12000003' THEN 'Yorkshire and The Humber' ELSE NULL END,\n                    'E12000004', CASE WHEN ctryrgn_a.rgn_aoo ? 'E12000004' THEN 'East Midlands' ELSE NULL END,\n                    'E12000005', CASE WHEN ctryrgn_a.rgn_aoo ? 'E12000005' THEN 'West Midlands' ELSE NULL END,\n                    'E12000006', CASE WHEN ctryrgn_a.rgn_aoo ? 'E12000006' THEN 'East of England' ELSE NULL END,\n                    'E12000007', CASE WHEN ctryrgn_a.rgn_aoo ? 'E12000007' THEN 'London' ELSE NULL END,\n                    'E12000008', CASE WHEN ctryrgn_a.rgn_aoo ? 'E12000008' THEN 'South East' ELSE NULL END,\n                    'E12000009', CASE WHEN ctryrgn_a.rgn_aoo ? 'E12000009' THEN 'South West' ELSE NULL END\n                )) AS rgn_aoo_name,\n                ctryrgn_a.ctry_aoo,\n                jsonb_strip_nulls(jsonb_build_object(\n                    'E92000001', CASE WHEN ctryrgn_a.ctry_aoo ? 'E92000001' THEN 'England' ELSE NULL END,\n                    'N92000002', CASE WHEN ctryrgn_a.ctry_aoo ? 'N92000002' THEN 'Northern Ireland' ELSE NULL END,\n                    'S92000003', CASE WHEN ctryrgn_a.ctry_aoo ? 'S92000003' THEN 'Scotland' ELSE NULL END,\n                    'W92000004', CASE WHEN ctryrgn_a.ctry_aoo ? 'W92000004' THEN 'Wales' ELSE NULL END\n                )) AS ctry_aoo_name,\n                f.overseas_aoo,\n                f.overseas_aoo_name,\n                -- London Analysis\n                f.london_aoo,\n                f.london_hq\n            FROM ukgrantmaking_funder f\n                LEFT OUTER JOIN ctryrgn_a\n                    ON f.org_id = ctryrgn_a.org_id\n        ),\n        financial_year_base AS (\n            SELECT ukgrantmaking_financialyear.fy,\n                ukgrantmaking_financialyear.funders_start_date,\n                ukgrantmaking_financialyear.funders_end_date,\n                ukgrantmaking_financialyear.grants_start_date,\n                ukgrantmaking_financialyear.grants_end_date,\n                ukgrantmaking_financialyear.current,\n                ukgrantmaking_financialyear.status\n            FROM ukgrantmaking_financialyear\n            WHERE (ukgrantmaking_financialyear.status::text = ANY (ARRAY['Open'::character varying, 'Closed'::character varying]::text[])) OR ukgrantmaking_financialyear.current\n            ORDER BY ukgrantmaking_financialyear.fy DESC\n            LIMIT 5\n        ),\n        financial_years AS (\n            SELECT array_agg(fy) AS fya\n            FROM financial_year_base\n        )\n        SELECT\n            ufv.segment,\n            ufv.category,\n            ufv.org_id,\n            ufv.name,\n            -- Create HTML name with 360Giving logo for publishers based on the 360Giving publisher tag\n        MAX(CASE\n                WHEN tags_list_year ILIKE '%%360Giving Publisher%%'\n                THEN CONCAT(ufv.name, '<small><img decoding=\"async\" src=\"https://cdn.threesixtygiving.org/components/preview/assets/images/360-logos/icon/360giving-icon.svg\" style=\"width: 24px;\"></small>')\n                ELSE ufv.name\n            END) AS \"HTML_name\",\n\n            -- Add key metrics for last 5 years\n            -- year 1(most recent) \n            MAX(fy) FILTER (WHERE fy = fya[1]) AS \"year1_fy\",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[1]) AS \"year1_financial_year_end\",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[1]) AS \"year1_Grantmaking_GBP_m\",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) DESC NULLS LAST) AS \"year1_Grantmaking_Rank\",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[1]) AS \"year1_Grantmaking_Band\",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[1]) AS \"year1_Grantmaking_Individuals_GBP_m\",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[1]) DESC NULLS LAST) AS \"year1_Grantmaking_Individuals_Rank\",\n            MAX(income_m) FILTER (WHERE fy = fya[1]) AS \"year1_Income_GBP_m\",\n            MAX(spending_m) FILTER (WHERE fy = fya[1]) AS \"year1_Spending_GBP_m\",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[1]) AS \"year1_Net_Assets_GBP_m\",\n            MAX(employees) FILTER (WHERE fy = fya[1]) AS \"year1_Employees\",\n            \n            -- year 2 \n            MAX(fy) FILTER (WHERE fy = fya[2]) AS \"year2_fy\",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[2]) AS \"year2_financial_year_end\",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[2]) AS \"year2_Grantmaking_GBP_m\",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[2]) DESC NULLS LAST) AS \"year2_Grantmaking_Rank\",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[2]) AS \"year2_Grantmaking_Band\",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[2]) AS \"year2_Grantmaking_Individuals_GBP_m\",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[2]) DESC NULLS LAST) AS \"year2_Grantmaking_Individuals_Rank\",\n            MAX(income_m) FILTER (WHERE fy = fya[2]) AS \"year2_Income_GBP_m\",\n            MAX(spending_m) FILTER (WHERE fy = fya[2]) AS \"year2_Spending_GBP_m\",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[2]) AS \"year2_Net_Assets_GBP_m\",\n            MAX(employees) FILTER (WHERE fy = fya[2]) AS \"year2_Employees\",\n            \n            -- year 3\n            MAX(fy) FILTER (WHERE fy = fya[3]) AS \"year3_fy\",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[3]) AS \"year3_financial_year_end\",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[3]) AS \"year3_Grantmaking_GBP_m\",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[3]) DESC NULLS LAST) AS \"year3_Grantmaking_Rank\",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[3]) AS \"year3_Grantmaking_Band\",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[3]) AS \"year3_Grantmaking_Individuals_GBP_m\",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[3]) DESC NULLS LAST) AS \"year3_Grantmaking_Individuals_Rank\",\n            MAX(income_m) FILTER (WHERE fy = fya[3]) AS \"year3_Income_GBP_m\",\n            MAX(spending_m) FILTER (WHERE fy = fya[3]) AS \"year3_Spending_GBP_m\",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[3]) AS \"year3_Net_Assets_GBP_m\",\n            MAX(employees) FILTER (WHERE fy = fya[3]) AS \"year3_Employees\",\n            \n            -- year 4\n            MAX(fy) FILTER (WHERE fy = fya[4]) AS \"year4_fy\",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[4]) AS \"year4_financial_year_end\",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[4]) AS \"year4_Grantmaking_GBP_m\",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[4]) DESC NULLS LAST) AS \"year4_Grantmaking_Rank\",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[4]) AS \"year4_Grantmaking_Band\",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[4]) AS \"year4_Grantmaking_Individuals_GBP_m\",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[4]) DESC NULLS LAST) AS \"year4_Grantmaking_Individuals_Rank\",\n            MAX(income_m) FILTER (WHERE fy = fya[4]) AS \"year4_Income_GBP_m\",\n            MAX(spending_m) FILTER (WHERE fy = fya[4]) AS \"year4_Spending_GBP_m\",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[4]) AS \"year4_Net_Assets_GBP_m\",\n            MAX(employees) FILTER (WHERE fy = fya[4]) AS \"year4_Employees\",\n            \n            -- year 5\n            MAX(fy) FILTER (WHERE fy = fya[5]) AS \"year5_fy\",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[5]) AS \"year5_financial_year_end\",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[5]) AS \"year5_Grantmaking_GBP_m\",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[5]) DESC NULLS LAST) AS \"year5_Grantmaking_Rank\",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[5]) AS \"year5_Grantmaking_Band\",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[5]) AS \"year5_Grantmaking_Individuals_GBP_m\",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[5]) DESC NULLS LAST) AS \"year5_Grantmaking_Individuals_Rank\",\n            MAX(income_m) FILTER (WHERE fy = fya[5]) AS \"year5_Income_GBP_m\",\n            MAX(spending_m) FILTER (WHERE fy = fya[5]) AS \"year5_Spending_GBP_m\",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[5]) AS \"year5_Net_Assets_GBP_m\",\n            MAX(employees) FILTER (WHERE fy = fya[5]) AS \"year5_Employees\",\n            \n            -- Funder location/regulator details \n            MAX(fd.charity_number) AS charity_number,\n            MAX(fd.active::text) AS active, \n            MAX(fd.date_of_registration) AS date_of_registration,\n            MAX(fd.how::text) AS how,  \n            MAX(fd.what::text) AS what, \n            MAX(fd.who::text) AS who,\n            MAX(fd.scale::text) AS scale,\n\n            -- HQ Location Codes and Names\n            MAX(fd.la_hq::text) AS la_hq,\n            MAX(fd.la_hq_name::text) AS la_hq_name,\n            MAX(fd.rgn_hq::text) AS rgn_hq,\n            MAX(fd.rgn_hq_name::text) AS rgn_hq_name, \n            MAX(fd.ctry_hq::text) AS ctry_hq,\n            MAX(fd.ctry_hq_name::text) AS ctry_hq_name,\n\n            -- AOO Location Codes and Names\n            MAX(fd.la_aoo::text) AS la_aoo,\n            MAX(fd.la_aoo_name::text) AS la_aoo_name,\n            MAX(fd.rgn_aoo::text) AS rgn_aoo,\n            MAX(fd.rgn_aoo_name::text) AS rgn_aoo_name,  \n            MAX(fd.ctry_aoo::text) AS ctry_aoo,\n            MAX(fd.ctry_aoo_name::text) AS ctry_aoo_name,  \n            MAX(fd.overseas_aoo::text) AS overseas_aoo,\n            MAX(fd.overseas_aoo_name::text) AS overseas_aoo_name,  \n            \n            MAX(fd.london_aoo::text) AS london_aoo, \n            MAX(fd.london_hq::text) AS london_hq,  \n            \n            -- check for 2 years of data (last 2 years) \n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending_grant_making IS NOT NULL) = 2) AS \"has_2yrs_Grantmaking\",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending_grant_making_individuals IS NOT NULL) = 2) AS \"has_2yrs_Grantmaking_Individuals\",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND income IS NOT NULL) = 2) AS \"has_2yrs_Income\",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending IS NOT NULL) = 2) AS \"has_2yrs_Spending\",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND total_net_assets IS NOT NULL) = 2) AS \"has_2yrs_Net_Assets\",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND employees IS NOT NULL) = 2) AS \"has_2yrs_Employees\",\n            \n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND spending_grant_making IS NOT NULL) = 3 AS \"has_3yrs_Grantmaking\",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND spending_grant_making_individuals IS NOT NULL) = 3 AS \"has_3yrs_Grantmaking_Individuals\",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND income IS NOT NULL) = 3 AS \"has_3yrs_Income\",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND spending IS NOT NULL) = 3 AS \"has_3yrs_Spending\",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND total_net_assets IS NOT NULL) = 3 AS \"has_3yrs_Net_Assets\",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND employees IS NOT NULL) = 3 AS \"has_3yrs_Employees\",\n\n            (CASE\n            WHEN MAX(income) FILTER (WHERE fy = fya[1]) IS NULL \n            AND MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) IS NULL \n            THEN 0\n\n            WHEN MAX(income) FILTER (WHERE fy = fya[1]) < 5000 \n            AND MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) < 5000 \n            THEN 0\n\n            ELSE 1\n            END) > 0 AS \"include_in_analysis\",\n            ufv.makes_grants_to_individuals\n        FROM\n            ufv\n        LEFT JOIN funder_details fd ON ufv.org_id = fd.org_id,\n            financial_years\n        GROUP BY\n            ufv.segment,\n            ufv.category,\n            ufv.org_id,\n            ufv.name,\n            ufv.makes_grants_to_individuals\n        ORDER BY \n            MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) DESC NULLS LAST",
                "ukgrantmaking_funders_analysis_view",
                engine="django.db.backends.postgresql",
            ),
            reverse_code=django_db_views.migration_functions.BackwardViewMigration(
                'WITH ufv AS (\n        SELECT \n            segment,\n            category,\n            org_id,\n            name,\n            fy,\n            tags_list_year,\n            financial_year_end,\n            spending_grant_making,\n            spending_grant_making_individuals,\n            income,\n            spending,\n            total_net_assets,\n            employees,\n            makes_grants_to_individuals,\n            -- Convert key metrics to millions\n            spending_grant_making / 1000000.0 AS grantmaking_m,\n            spending_grant_making_individuals / 1000000.0 AS grantmaking_individuals_m,\n            income / 1000000.0 AS income_m,\n            spending / 1000000.0 AS spending_m,\n            total_net_assets / 1000000.0 AS net_assets_m,\n            -- Define grantmaking bands\n            CASE \n                WHEN spending_grant_making IS NULL OR spending_grant_making = 0 \n                THEN \'Zero/Unknown Spend\'\n                WHEN spending_grant_making > 0 AND spending_grant_making < 100000 \n                THEN \'Under £100k\'\n                WHEN spending_grant_making >= 100000 AND spending_grant_making <= 1000000 \n                THEN \'£100k-£1m\'\n                WHEN spending_grant_making > 1000000 AND spending_grant_making <= 10000000 \n                THEN \'£1m-£10m\'\n                WHEN spending_grant_making > 10000000 AND spending_grant_making <= 100000000 \n                THEN \'£10m-£100m\'\n                WHEN spending_grant_making > 100000000 \n                THEN \'Over £100m\'\n            END AS grantmaking_band\n        FROM ukgrantmaking_funders_view\n        ),\n        -- add funder regulator details from funder table\n        funder_details AS (\n            SELECT\n                org_id,\n                charity_number,\n                active,\n                date_of_registration,\n                how,\n                what,\n                who,\n                scale,\n                postcode,\n                -- HQ\n                la_hq,\n                la_hq_name,\n                rgn_hq,\n                rgn_hq_name,\n                ctry_hq,\n                ctry_hq_name,\n                -- AOO\n                la_aoo,\n                la_aoo_name,\n                rgn_aoo,\n                rgn_aoo_name,\n                ctry_aoo,\n                ctry_aoo_name,\n                overseas_aoo,\n                overseas_aoo_name,\n                -- London Analysis\n                london_aoo,\n                london_hq\n            FROM ukgrantmaking_funder\n        ),\n        financial_year_base AS (\n            SELECT ukgrantmaking_financialyear.fy,\n                ukgrantmaking_financialyear.funders_start_date,\n                ukgrantmaking_financialyear.funders_end_date,\n                ukgrantmaking_financialyear.grants_start_date,\n                ukgrantmaking_financialyear.grants_end_date,\n                ukgrantmaking_financialyear.current,\n                ukgrantmaking_financialyear.status\n            FROM ukgrantmaking_financialyear\n            WHERE (ukgrantmaking_financialyear.status::text = ANY (ARRAY[\'Open\'::character varying, \'Closed\'::character varying]::text[])) OR ukgrantmaking_financialyear.current\n            ORDER BY ukgrantmaking_financialyear.fy DESC\n            LIMIT 5\n        ),\n        financial_years AS (\n            SELECT array_agg(fy) AS fya\n            FROM financial_year_base\n        )\n        SELECT\n            ufv.segment,\n            ufv.category,\n            ufv.org_id,\n            ufv.name,\n            -- Create HTML name with 360Giving logo for publishers based on the 360Giving publisher tag\n        MAX(CASE\n                WHEN tags_list_year ILIKE \'%%360Giving Publisher%%\'\n                THEN CONCAT(ufv.name, \'<small><img decoding="async" src="https://cdn.threesixtygiving.org/components/preview/assets/images/360-logos/icon/360giving-icon.svg" style="width: 24px;"></small>\')\n                ELSE ufv.name\n            END) AS "HTML_name",\n\n            -- Add key metrics for last 5 years\n            -- year 1(most recent) \n            MAX(fy) FILTER (WHERE fy = fya[1]) AS "year1_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[1]) AS "year1_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[1]) AS "year1_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) DESC NULLS LAST) AS "year1_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[1]) AS "year1_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[1]) AS "year1_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[1]) DESC NULLS LAST) AS "year1_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[1]) AS "year1_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[1]) AS "year1_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[1]) AS "year1_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[1]) AS "year1_Employees",\n            \n            -- year 2 \n            MAX(fy) FILTER (WHERE fy = fya[2]) AS "year2_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[2]) AS "year2_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[2]) AS "year2_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[2]) DESC NULLS LAST) AS "year2_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[2]) AS "year2_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[2]) AS "year2_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[2]) DESC NULLS LAST) AS "year2_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[2]) AS "year2_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[2]) AS "year2_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[2]) AS "year2_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[2]) AS "year2_Employees",\n            \n            -- year 3\n            MAX(fy) FILTER (WHERE fy = fya[3]) AS "year3_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[3]) AS "year3_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[3]) AS "year3_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[3]) DESC NULLS LAST) AS "year3_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[3]) AS "year3_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[3]) AS "year3_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[3]) DESC NULLS LAST) AS "year3_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[3]) AS "year3_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[3]) AS "year3_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[3]) AS "year3_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[3]) AS "year3_Employees",\n            \n            -- year 4\n            MAX(fy) FILTER (WHERE fy = fya[4]) AS "year4_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[4]) AS "year4_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[4]) AS "year4_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[4]) DESC NULLS LAST) AS "year4_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[4]) AS "year4_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[4]) AS "year4_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[4]) DESC NULLS LAST) AS "year4_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[4]) AS "year4_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[4]) AS "year4_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[4]) AS "year4_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[4]) AS "year4_Employees",\n            \n            -- year 5\n            MAX(fy) FILTER (WHERE fy = fya[5]) AS "year5_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[5]) AS "year5_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[5]) AS "year5_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[5]) DESC NULLS LAST) AS "year5_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[5]) AS "year5_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[5]) AS "year5_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[5]) DESC NULLS LAST) AS "year5_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[5]) AS "year5_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[5]) AS "year5_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[5]) AS "year5_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[5]) AS "year5_Employees",\n            \n            -- Funder location/regulator details \n            MAX(fd.charity_number) AS charity_number,\n            MAX(fd.active::text) AS active, \n            MAX(fd.date_of_registration) AS date_of_registration,\n            MAX(fd.how::text) AS how,  \n            MAX(fd.what::text) AS what, \n            MAX(fd.who::text) AS who,\n            MAX(fd.scale::text) AS scale,\n\n            -- HQ Location Codes and Names\n            MAX(fd.la_hq::text) AS la_hq,\n            MAX(fd.la_hq_name::text) AS la_hq_name,\n            MAX(fd.rgn_hq::text) AS rgn_hq,\n            MAX(fd.rgn_hq_name::text) AS rgn_hq_name, \n            MAX(fd.ctry_hq::text) AS ctry_hq,\n            MAX(fd.ctry_hq_name::text) AS ctry_hq_name,\n\n            -- AOO Location Codes and Names\n            MAX(fd.la_aoo::text) AS la_aoo,\n            MAX(fd.la_aoo_name::text) AS la_aoo_name,\n            MAX(fd.rgn_aoo::text) AS rgn_aoo,\n            MAX(fd.rgn_aoo_name::text) AS rgn_aoo_name,  \n            MAX(fd.ctry_aoo::text) AS ctry_aoo,\n            MAX(fd.ctry_aoo_name::text) AS ctry_aoo_name,  \n            MAX(fd.overseas_aoo::text) AS overseas_aoo,\n            MAX(fd.overseas_aoo_name::text) AS overseas_aoo_name,  \n            \n            MAX(fd.london_aoo::text) AS london_aoo, \n            MAX(fd.london_hq::text) AS london_hq,  \n            \n            -- check for 2 years of data (last 2 years) \n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending_grant_making IS NOT NULL) = 2) AS "has_2yrs_Grantmaking",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending_grant_making_individuals IS NOT NULL) = 2) AS "has_2yrs_Grantmaking_Individuals",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND income IS NOT NULL) = 2) AS "has_2yrs_Income",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending IS NOT NULL) = 2) AS "has_2yrs_Spending",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND total_net_assets IS NOT NULL) = 2) AS "has_2yrs_Net_Assets",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND employees IS NOT NULL) = 2) AS "has_2yrs_Employees",\n            \n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND spending_grant_making IS NOT NULL) = 3 AS "has_3yrs_Grantmaking",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND spending_grant_making_individuals IS NOT NULL) = 3 AS "has_3yrs_Grantmaking_Individuals",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND income IS NOT NULL) = 3 AS "has_3yrs_Income",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND spending IS NOT NULL) = 3 AS "has_3yrs_Spending",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND total_net_assets IS NOT NULL) = 3 AS "has_3yrs_Net_Assets",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND employees IS NOT NULL) = 3 AS "has_3yrs_Employees",\n\n            (CASE\n            WHEN MAX(income) FILTER (WHERE fy = fya[1]) IS NULL \n            AND MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) IS NULL \n            THEN 0\n\n            WHEN MAX(income) FILTER (WHERE fy = fya[1]) < 5000 \n            AND MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) < 5000 \n            THEN 0\n\n            ELSE 1\n            END) > 0 AS "include_in_analysis",\n            ufv.makes_grants_to_individuals\n        FROM\n            ufv\n        LEFT JOIN funder_details fd ON ufv.org_id = fd.org_id,\n            financial_years\n        GROUP BY\n            ufv.segment,\n            ufv.category,\n            ufv.org_id,\n            ufv.name,\n            ufv.makes_grants_to_individuals\n        ORDER BY \n            MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) DESC NULLS LAST',
                "ukgrantmaking_funders_analysis_view",
                engine="django.db.backends.postgresql",
            ),
            atomic=False,
        ),
        django_db_views.operations.ViewRunPython(
            code=django_db_views.migration_functions.ForwardViewMigration(
                'WITH base AS (\n            SELECT org_id,\n                "name",\n                segment,\n                category,\n                "scale",\n                f."year1_Grantmaking_GBP_m" AS "grantmaking",\n                "scale" ILIKE \'%%overseas%%\' AS "overseas",\n                ctry_aoo::jsonb ? \'E92000001\' AS "england",\n                ctry_aoo::jsonb ? \'N92000002\' AS "northern_ireland",\n                ctry_aoo::jsonb ? \'S92000003\' AS "scotland",\n                ctry_aoo::jsonb ? \'W92000004\' AS "wales",\n                rgn_aoo::jsonb ? \'E12000001\' AS "england_northeast",\n                rgn_aoo::jsonb ? \'E12000002\' AS "england_northwest",\n                rgn_aoo::jsonb ? \'E12000003\' AS "england_yorkshire",\n                rgn_aoo::jsonb ? \'E12000004\' AS "england_eastmidlands",\n                rgn_aoo::jsonb ? \'E12000005\' AS "england_westmidlands",\n                rgn_aoo::jsonb ? \'E12000006\' AS "england_east",\n                rgn_aoo::jsonb ? \'E12000007\' AS "england_london",\n                rgn_aoo::jsonb ? \'E12000008\' AS "england_southeast",\n                rgn_aoo::jsonb ? \'E12000009\' AS "england_southwest"\n            FROM ukgrantmaking_funders_analysis_view f\n            ORDER BY f."year1_Grantmaking_Rank"\n        )\n        SELECT org_id,\n            "name",\n            segment,\n            category,\n            "scale",\n            grantmaking,\n            CASE WHEN "scale" IN (\'National and Overseas\', \'Overseas\') THEN "scale"\n                WHEN "scale" = \'National\' THEN \n                    CASE WHEN "england" AND "northern_ireland" AND "scotland" AND "wales" THEN \'United Kingdom\'\n                        WHEN "england" AND "scotland" AND "wales" THEN \'Great Britain\'\n                        WHEN "england" AND "wales" THEN \'England and Wales\'\n                        WHEN "england" THEN \'England\'\n                        WHEN "wales" THEN \'Wales\'\n                        WHEN "scotland" THEN \'Scotland\'\n                        WHEN "northern_ireland" THEN \'Northern Ireland\'\n                        ELSE \'Other National\' END\n                WHEN "scale" = \'Regional\' THEN \'Regional\'\n                WHEN "scale" = \'Local\' THEN \'Local\'\n                ELSE \'Other\' END AS "geoarea",\n            "overseas",\n            "england",\n            "northern_ireland",\n            "scotland",\n            "wales",\n            "england_northeast",\n            "england_northwest",\n            "england_yorkshire",\n            "england_eastmidlands",\n            "england_westmidlands",\n            "england_east",\n            "england_london",\n            "england_southeast",\n            "england_southwest"\n        FROM base\n        ORDER BY grantmaking DESC NULLS LAST',
                "ukgrantmaking_funders_regional_view",
                engine="django.db.backends.postgresql",
            ),
            reverse_code=django_db_views.migration_functions.BackwardViewMigration(
                "",
                "ukgrantmaking_funders_regional_view",
                engine="django.db.backends.postgresql",
            ),
            atomic=False,
        ),
    ]
