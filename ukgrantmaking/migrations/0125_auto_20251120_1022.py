# Generated by Django 5.0.6 on 2025-11-20 10:22

import django_db_views.migration_functions
import django_db_views.operations
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("ukgrantmaking", "0124_auto_20251120_1010"),
    ]

    operations = [
        django_db_views.operations.ViewRunPython(
            code=django_db_views.migration_functions.ForwardViewMigration(
                "WITH fy AS (\n                SELECT *\n                FROM ukgrantmaking_financialyear\n                WHERE status IN ('Open', 'Closed')\n                    OR \"current\" \n                ORDER BY fy DESC\n                LIMIT 5\n            ),\n            spend_data AS (\n                SELECT coalesce(new_funder_financial_year_id, funder_financial_year_id) AS funder_financial_year_id,\n                    max(financial_year_end) AS financial_year_end,\n                    sum(income) AS income,\n                    sum(income_investment) AS income_investment,\n                    sum(spending) AS spending,\n                    sum(spending_investment) AS spending_investment,\n                    sum(spending_charitable) AS spending_charitable,\n                    sum(spending_grant_making) AS spending_grant_making,\n                    sum(spending_grant_making_individuals) AS spending_grant_making_individuals,\n                    sum(spending_grant_making_institutions) AS spending_grant_making_institutions\n                FROM ukgrantmaking_funderyear\n                GROUP BY 1\n            ),\n            balance_sheet AS (\n                SELECT DISTINCT ON (coalesce(new_funder_financial_year_id, funder_financial_year_id))\n                    coalesce(new_funder_financial_year_id, funder_financial_year_id) AS funder_financial_year_id,\n                    financial_year_end,\n                    total_net_assets,\n                    funds,\n                    case when (\n                        funds_endowment IS NOT NULL OR  \n                        funds_restricted IS NOT NULL OR  \n                        funds_unrestricted IS NOT NULL\n                    ) then (\n                        coalesce(funds_endowment, 0) + \n                        coalesce(funds_restricted, 0) + \n                        coalesce(funds_unrestricted, 0)\n                    ) else null end as funds_calculated,\n                    case when (\n                        funds_endowment IS NOT NULL OR  \n                        funds_restricted IS NOT NULL OR  \n                        funds_unrestricted IS NOT NULL\n                    ) then coalesce(funds_endowment, 0) else null end as funds_endowment,\n                    case when (\n                        funds_endowment IS NOT NULL OR  \n                        funds_restricted IS NOT NULL OR  \n                        funds_unrestricted IS NOT NULL\n                    ) then coalesce(funds_restricted, 0) else null end as funds_restricted,\n                    case when (\n                        funds_endowment IS NOT NULL OR  \n                        funds_restricted IS NOT NULL OR  \n                        funds_unrestricted IS NOT NULL\n                    ) then coalesce(funds_unrestricted, 0) else null end as funds_unrestricted,\n                    employees,\n                    case when (\n                        employees_permanent IS NOT NULL OR  \n                        employees_fixedterm IS NOT NULL OR  \n                        employees_selfemployed IS NOT NULL\n                    ) then (\n                        coalesce(employees_permanent, 0) + \n                        coalesce(employees_fixedterm, 0) + \n                        coalesce(employees_selfemployed, 0)\n                    ) else null end as employees_calculated,\n                    case when (\n                        employees_permanent IS NOT NULL OR  \n                        employees_fixedterm IS NOT NULL OR  \n                        employees_selfemployed IS NOT NULL\n                    ) then coalesce(employees_permanent, 0) else null end as employees_permanent,\n                    case when (\n                        employees_permanent IS NOT NULL OR  \n                        employees_fixedterm IS NOT NULL OR  \n                        employees_selfemployed IS NOT NULL\n                    ) then coalesce(employees_fixedterm, 0) else null end as employees_fixedterm,\n                    case when (\n                        employees_permanent IS NOT NULL OR  \n                        employees_fixedterm IS NOT NULL OR  \n                        employees_selfemployed IS NOT NULL\n                    ) then coalesce(employees_selfemployed, 0) else null end as employees_selfemployed\n                FROM ukgrantmaking_funderyear\n                ORDER BY coalesce(new_funder_financial_year_id, funder_financial_year_id),\n                    financial_year_end DESC\n            ),\n            tags_year AS (\n                SELECT funderfinancialyear_id,\n                    array_agg(t.tag) AS tags,\n                    string_agg(t.tag, ';') AS tags_list,\n                    json_agg(t.tag) AS tags_json\n                FROM ukgrantmaking_funderfinancialyear_tags ffyt\n                    INNER JOIN ukgrantmaking_fundertag t\n                        ON ffyt.fundertag_id = t.slug \n                GROUP BY 1\n            ),\n            tags AS (\n                SELECT funder_id,\n                    array_agg(t.tag) AS tags,\n                    string_agg(t.tag, ';') AS tags_list,\n                    json_agg(t.tag) AS tags_json\n                FROM ukgrantmaking_funder_tags ft\n                    INNER JOIN ukgrantmaking_fundertag t\n                        ON ft.fundertag_id = t.slug \n                GROUP BY 1\n            )\n            SELECT f.org_id,\n                f.\"name\",\n                f.segment,\n                f.category,\n                f.makes_grants_to_individuals,\n                tags.tags,\n                fy.fy,\n                spend_data.financial_year_end,\n                spend_data.income,\n                spend_data.income_investment,\n                spend_data.spending,\n                spend_data.spending_investment,\n                spend_data.spending_charitable,\n                spend_data.spending_grant_making,\n                spend_data.spending_grant_making_individuals,\n                spend_data.spending_grant_making_institutions,\n                coalesce(\n                    balance_sheet.total_net_assets,\n                    balance_sheet.funds_calculated\n                ) AS total_net_assets,\n                coalesce(\n                    balance_sheet.funds,\n                    balance_sheet.funds_calculated\n                ) AS funds,\n                balance_sheet.funds_endowment,\n                balance_sheet.funds_restricted,\n                balance_sheet.funds_unrestricted,\n                balance_sheet.employees,\n                balance_sheet.employees_permanent,\n                balance_sheet.employees_fixedterm,\n                balance_sheet.employees_selfemployed,\n                ffy.checked,\n                ffy.checked_by_id,\n                ffy.checked_on,\n                tags.tags_list,\n                tags.tags_json,\n                tags.tags_json::TEXT AS tags_json_text,\n                ffy.segment AS segment_year,\n                ffy.category AS category_year,\n                ffy.makes_grants_to_individuals AS makes_grants_to_individuals_year,\n                tags_year.tags_list as tags_list_year,\n                ffy.included AS included_year\n            FROM ukgrantmaking_funderfinancialyear ffy \n                INNER JOIN fy\n                    ON ffy.financial_year_id = fy.fy \n                INNER JOIN ukgrantmaking_funder f\n                    ON ffy.funder_id = f.org_id \n                LEFT OUTER JOIN tags_year\n                    ON tags_year.funderfinancialyear_id = ffy.id\n                LEFT OUTER JOIN tags\n                    ON tags.funder_id = f.org_id\n                LEFT OUTER JOIN spend_data\n                    ON spend_data.funder_financial_year_id = ffy.id\n                LEFT OUTER JOIN balance_sheet\n                    ON balance_sheet.funder_financial_year_id = ffy.id\n            WHERE f.included\n            ORDER BY fy.fy DESC, spending_grant_making DESC NULLS LAST",
                "ukgrantmaking_funders_view",
                engine="django.db.backends.postgresql",
            ),
            reverse_code=django_db_views.migration_functions.BackwardViewMigration(
                "", "ukgrantmaking_funders_view", engine="django.db.backends.postgresql"
            ),
            atomic=False,
        ),
    ]
