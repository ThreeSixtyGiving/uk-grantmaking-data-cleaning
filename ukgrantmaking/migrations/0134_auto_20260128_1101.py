# Generated by Django 5.2.8 on 2026-01-28 11:01

import django_db_views.migration_functions
import django_db_views.operations
from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('ukgrantmaking', '0133_auto_20251204_1215'),
    ]

    operations = [
        django_db_views.operations.ViewRunPython(
            code=django_db_views.migration_functions.ForwardViewMigration('WITH ufv AS (\n        SELECT \n            segment,\n            category,\n            org_id,\n            name,\n            fy,\n            tags_list_year,\n            financial_year_end,\n            spending_grant_making,\n            spending_grant_making_individuals,\n            income,\n            spending,\n            total_net_assets,\n            employees,\n            makes_grants_to_individuals,\n            -- Convert key metrics to millions\n            spending_grant_making / 1000000.0 AS grantmaking_m,\n            spending_grant_making_individuals / 1000000.0 AS grantmaking_individuals_m,\n            income / 1000000.0 AS income_m,\n            spending / 1000000.0 AS spending_m,\n            total_net_assets / 1000000.0 AS net_assets_m,\n            -- Define grantmaking bands\n            CASE \n                WHEN spending_grant_making IS NULL OR spending_grant_making = 0 \n                THEN \'Zero/Unknown Spend\'\n                WHEN spending_grant_making > 0 AND spending_grant_making < 100000 \n                THEN \'Under £100k\'\n                WHEN spending_grant_making >= 100000 AND spending_grant_making <= 1000000 \n                THEN \'£100k-£1m\'\n                WHEN spending_grant_making > 1000000 AND spending_grant_making <= 10000000 \n                THEN \'£1m-£10m\'\n                WHEN spending_grant_making > 10000000 AND spending_grant_making <= 100000000 \n                THEN \'£10m-£100m\'\n                WHEN spending_grant_making > 100000000 \n                THEN \'Over £100m\'\n            END AS grantmaking_band\n        FROM ukgrantmaking_funders_view\n        ),\n        -- add funder regulator details from funder table\n        funder_details AS (\n            SELECT\n                org_id,\n                charity_number,\n                active,\n                date_of_registration,\n                how,\n                what,\n                who,\n                scale,\n                postcode,\n                -- HQ\n                la_hq,\n                la_hq_name,\n                rgn_hq,\n                rgn_hq_name,\n                ctry_hq,\n                ctry_hq_name,\n                -- AOO\n                la_aoo,\n                la_aoo_name,\n                rgn_aoo,\n                rgn_aoo_name,\n                ctry_aoo,\n                ctry_aoo_name,\n                overseas_aoo,\n                overseas_aoo_name,\n                -- London Analysis\n                london_aoo,\n                london_hq\n            FROM ukgrantmaking_funder\n        ),\n        financial_year_base AS (\n            SELECT ukgrantmaking_financialyear.fy,\n                ukgrantmaking_financialyear.funders_start_date,\n                ukgrantmaking_financialyear.funders_end_date,\n                ukgrantmaking_financialyear.grants_start_date,\n                ukgrantmaking_financialyear.grants_end_date,\n                ukgrantmaking_financialyear.current,\n                ukgrantmaking_financialyear.status\n            FROM ukgrantmaking_financialyear\n            WHERE (ukgrantmaking_financialyear.status::text = ANY (ARRAY[\'Open\'::character varying, \'Closed\'::character varying]::text[])) OR ukgrantmaking_financialyear.current\n            ORDER BY ukgrantmaking_financialyear.fy DESC\n            LIMIT 5\n        ),\n        financial_years AS (\n            SELECT array_agg(fy) AS fya\n            FROM financial_year_base\n        )\n        SELECT\n            ufv.segment,\n            ufv.category,\n            ufv.org_id,\n            ufv.name,\n            -- Create HTML name with 360Giving logo for publishers based on the 360Giving publisher tag\n        MAX(CASE\n                WHEN tags_list_year ILIKE \'%%360Giving Publisher%%\'\n                THEN CONCAT(ufv.name, \'<small><img decoding="async" src="https://cdn.threesixtygiving.org/components/preview/assets/images/360-logos/icon/360giving-icon.svg" style="width: 24px;"></small>\')\n                ELSE ufv.name\n            END) AS "HTML_name",\n\n            -- Add key metrics for last 5 years\n            -- year 1(most recent) \n            MAX(fy) FILTER (WHERE fy = fya[1]) AS "year1_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[1]) AS "year1_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[1]) AS "year1_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) DESC NULLS LAST) AS "year1_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[1]) AS "year1_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[1]) AS "year1_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[1]) DESC NULLS LAST) AS "year1_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[1]) AS "year1_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[1]) AS "year1_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[1]) AS "year1_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[1]) AS "year1_Employees",\n            \n            -- year 2 \n            MAX(fy) FILTER (WHERE fy = fya[2]) AS "year2_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[2]) AS "year2_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[2]) AS "year2_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[2]) DESC NULLS LAST) AS "year2_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[2]) AS "year2_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[2]) AS "year2_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[2]) DESC NULLS LAST) AS "year2_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[2]) AS "year2_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[2]) AS "year2_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[2]) AS "year2_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[2]) AS "year2_Employees",\n            \n            -- year 3\n            MAX(fy) FILTER (WHERE fy = fya[3]) AS "year3_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[3]) AS "year3_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[3]) AS "year3_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[3]) DESC NULLS LAST) AS "year3_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[3]) AS "year3_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[3]) AS "year3_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[3]) DESC NULLS LAST) AS "year3_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[3]) AS "year3_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[3]) AS "year3_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[3]) AS "year3_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[3]) AS "year3_Employees",\n            \n            -- year 4\n            MAX(fy) FILTER (WHERE fy = fya[4]) AS "year4_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[4]) AS "year4_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[4]) AS "year4_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[4]) DESC NULLS LAST) AS "year4_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[4]) AS "year4_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[4]) AS "year4_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[4]) DESC NULLS LAST) AS "year4_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[4]) AS "year4_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[4]) AS "year4_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[4]) AS "year4_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[4]) AS "year4_Employees",\n            \n            -- year 5\n            MAX(fy) FILTER (WHERE fy = fya[5]) AS "year5_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[5]) AS "year5_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[5]) AS "year5_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[5]) DESC NULLS LAST) AS "year5_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[5]) AS "year5_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[5]) AS "year5_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[5]) DESC NULLS LAST) AS "year5_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[5]) AS "year5_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[5]) AS "year5_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[5]) AS "year5_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[5]) AS "year5_Employees",\n            \n            -- Funder location/regulator details \n            MAX(fd.charity_number) AS charity_number,\n            MAX(fd.active::text) AS active, \n            MAX(fd.date_of_registration) AS date_of_registration,\n            MAX(fd.how::text) AS how,  \n            MAX(fd.what::text) AS what, \n            MAX(fd.who::text) AS who,\n            MAX(fd.scale::text) AS scale,\n\n            -- HQ Location Codes and Names\n            MAX(fd.la_hq::text) AS la_hq,\n            MAX(fd.la_hq_name::text) AS la_hq_name,\n            MAX(fd.rgn_hq::text) AS rgn_hq,\n            MAX(fd.rgn_hq_name::text) AS rgn_hq_name, \n            MAX(fd.ctry_hq::text) AS ctry_hq,\n            MAX(fd.ctry_hq_name::text) AS ctry_hq_name,\n\n            -- AOO Location Codes and Names\n            MAX(fd.la_aoo::text) AS la_aoo,\n            MAX(fd.la_aoo_name::text) AS la_aoo_name,\n            MAX(fd.rgn_aoo::text) AS rgn_aoo,\n            MAX(fd.rgn_aoo_name::text) AS rgn_aoo_name,  \n            MAX(fd.ctry_aoo::text) AS ctry_aoo,\n            MAX(fd.ctry_aoo_name::text) AS ctry_aoo_name,  \n            MAX(fd.overseas_aoo::text) AS overseas_aoo,\n            MAX(fd.overseas_aoo_name::text) AS overseas_aoo_name,  \n            \n            MAX(fd.london_aoo::text) AS london_aoo, \n            MAX(fd.london_hq::text) AS london_hq,  \n            \n            -- check for 2 years of data (last 2 years) \n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending_grant_making IS NOT NULL) = 2) AS "has_2yrs_Grantmaking",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending_grant_making_individuals IS NOT NULL) = 2) AS "has_2yrs_Grantmaking_Individuals",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND income IS NOT NULL) = 2) AS "has_2yrs_Income",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending IS NOT NULL) = 2) AS "has_2yrs_Spending",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND total_net_assets IS NOT NULL) = 2) AS "has_2yrs_Net_Assets",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND employees IS NOT NULL) = 2) AS "has_2yrs_Employees",\n            \n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND spending_grant_making IS NOT NULL) = 3 AS "has_3yrs_Grantmaking",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND spending_grant_making_individuals IS NOT NULL) = 3 AS "has_3yrs_Grantmaking_Individuals",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND income IS NOT NULL) = 3 AS "has_3yrs_Income",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND spending IS NOT NULL) = 3 AS "has_3yrs_Spending",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND total_net_assets IS NOT NULL) = 3 AS "has_3yrs_Net_Assets",\n            COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2], fya[3]) AND employees IS NOT NULL) = 3 AS "has_3yrs_Employees",\n\n            (CASE\n            WHEN MAX(income) FILTER (WHERE fy = fya[1]) IS NULL \n            AND MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) IS NULL \n            THEN 0\n\n            WHEN MAX(income) FILTER (WHERE fy = fya[1]) < 5000 \n            AND MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) < 5000 \n            THEN 0\n\n            ELSE 1\n            END) > 0 AS "include_in_analysis",\n            ufv.makes_grants_to_individuals\n        FROM\n            ufv\n        LEFT JOIN funder_details fd ON ufv.org_id = fd.org_id,\n            financial_years\n        GROUP BY\n            ufv.segment,\n            ufv.category,\n            ufv.org_id,\n            ufv.name,\n            ufv.makes_grants_to_individuals\n        ORDER BY \n            MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) DESC NULLS LAST', 'ukgrantmaking_funders_analysis_view', engine='django.db.backends.postgresql'),
            reverse_code=django_db_views.migration_functions.BackwardViewMigration('WITH ufv AS (\n        SELECT \n            segment,\n            category,\n            org_id,\n            name,\n            fy,\n            tags_list_year,\n            financial_year_end,\n            spending_grant_making,\n            spending_grant_making_individuals,\n            income,\n            spending,\n            total_net_assets,\n            employees,\n            makes_grants_to_individuals,\n            -- Convert key metrics to millions\n            spending_grant_making / 1000000.0 AS grantmaking_m,\n            spending_grant_making_individuals / 1000000.0 AS grantmaking_individuals_m,\n            income / 1000000.0 AS income_m,\n            spending / 1000000.0 AS spending_m,\n            total_net_assets / 1000000.0 AS net_assets_m,\n            -- Define grantmaking bands\n            CASE \n                WHEN spending_grant_making IS NULL OR spending_grant_making = 0 \n                THEN \'Zero/Unknown Spend\'\n                WHEN spending_grant_making > 0 AND spending_grant_making < 100000 \n                THEN \'Under £100k\'\n                WHEN spending_grant_making >= 100000 AND spending_grant_making <= 1000000 \n                THEN \'£100k-£1m\'\n                WHEN spending_grant_making > 1000000 AND spending_grant_making <= 10000000 \n                THEN \'£1m-£10m\'\n                WHEN spending_grant_making > 10000000 AND spending_grant_making <= 100000000 \n                THEN \'£10m-£100m\'\n                WHEN spending_grant_making > 100000000 \n                THEN \'Over £100m\'\n            END AS grantmaking_band\n        FROM ukgrantmaking_funders_view\n        ),\n        -- add funder regulator details from funder table\n        funder_details AS (\n            SELECT\n                org_id,\n                charity_number,\n                active,\n                date_of_registration,\n                how,\n                what,\n                who,\n                scale,\n                postcode,\n                -- HQ\n                la_hq,\n                la_hq_name,\n                rgn_hq,\n                rgn_hq_name,\n                ctry_hq,\n                ctry_hq_name,\n                -- AOO\n                la_aoo,\n                la_aoo_name,\n                rgn_aoo,\n                rgn_aoo_name,\n                ctry_aoo,\n                ctry_aoo_name,\n                overseas_aoo,\n                overseas_aoo_name,\n                -- London Analysis\n                london_aoo,\n                london_hq\n            FROM ukgrantmaking_funder\n        ),\n        financial_year_base AS (\n            SELECT ukgrantmaking_financialyear.fy,\n                ukgrantmaking_financialyear.funders_start_date,\n                ukgrantmaking_financialyear.funders_end_date,\n                ukgrantmaking_financialyear.grants_start_date,\n                ukgrantmaking_financialyear.grants_end_date,\n                ukgrantmaking_financialyear.current,\n                ukgrantmaking_financialyear.status\n            FROM ukgrantmaking_financialyear\n            WHERE (ukgrantmaking_financialyear.status::text = ANY (ARRAY[\'Open\'::character varying, \'Closed\'::character varying]::text[])) OR ukgrantmaking_financialyear.current\n            ORDER BY ukgrantmaking_financialyear.fy DESC\n            LIMIT 5\n        ),\n        financial_years AS (\n            SELECT array_agg(fy) AS fya\n            FROM financial_year_base\n        )\n        SELECT\n            ufv.segment,\n            ufv.category,\n            ufv.org_id,\n            ufv.name,\n            -- Create HTML name with 360Giving logo for publishers based on the 360Giving publisher tag\n        MAX(CASE\n                WHEN tags_list_year ILIKE \'%%360Giving Publisher%%\'\n                THEN CONCAT(ufv.name, \'<small><img decoding="async" src="https://cdn.threesixtygiving.org/components/preview/assets/images/360-logos/icon/360giving-icon.svg" style="width: 24px;"></small>\')\n                ELSE ufv.name\n            END) AS "HTML_name",\n\n            -- Add key metrics for last 5 years\n            -- year 1(most recent) \n            MAX(fy) FILTER (WHERE fy = fya[1]) AS "year1_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[1]) AS "year1_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[1]) AS "year1_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) DESC NULLS LAST) AS "year1_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[1]) AS "year1_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[1]) AS "year1_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[1]) DESC NULLS LAST) AS "year1_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[1]) AS "year1_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[1]) AS "year1_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[1]) AS "year1_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[1]) AS "year1_Employees",\n            \n            -- year 2 \n            MAX(fy) FILTER (WHERE fy = fya[2]) AS "year2_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[2]) AS "year2_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[2]) AS "year2_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[2]) DESC NULLS LAST) AS "year2_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[2]) AS "year2_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[2]) AS "year2_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[2]) DESC NULLS LAST) AS "year2_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[2]) AS "year2_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[2]) AS "year2_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[2]) AS "year2_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[2]) AS "year2_Employees",\n            \n            -- year 3\n            MAX(fy) FILTER (WHERE fy = fya[3]) AS "year3_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[3]) AS "year3_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[3]) AS "year3_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[3]) DESC NULLS LAST) AS "year3_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[3]) AS "year3_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[3]) AS "year3_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[3]) DESC NULLS LAST) AS "year3_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[3]) AS "year3_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[3]) AS "year3_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[3]) AS "year3_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[3]) AS "year3_Employees",\n            \n            -- year 4\n            MAX(fy) FILTER (WHERE fy = fya[4]) AS "year4_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[4]) AS "year4_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[4]) AS "year4_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[4]) DESC NULLS LAST) AS "year4_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[4]) AS "year4_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[4]) AS "year4_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[4]) DESC NULLS LAST) AS "year4_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[4]) AS "year4_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[4]) AS "year4_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[4]) AS "year4_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[4]) AS "year4_Employees",\n            \n            -- year 5\n            MAX(fy) FILTER (WHERE fy = fya[5]) AS "year5_fy",\n            MAX(financial_year_end) FILTER (WHERE fy = fya[5]) AS "year5_financial_year_end",\n            MAX(grantmaking_m) FILTER (WHERE fy = fya[5]) AS "year5_Grantmaking_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making) FILTER (WHERE fy = fya[5]) DESC NULLS LAST) AS "year5_Grantmaking_Rank",\n            MAX(grantmaking_band) FILTER (WHERE fy = fya[5]) AS "year5_Grantmaking_Band",\n            MAX(grantmaking_individuals_m) FILTER (WHERE fy = fya[5]) AS "year5_Grantmaking_Individuals_GBP_m",\n            ROW_NUMBER() OVER (ORDER BY MAX(spending_grant_making_individuals) FILTER (WHERE fy = fya[5]) DESC NULLS LAST) AS "year5_Grantmaking_Individuals_Rank",\n            MAX(income_m) FILTER (WHERE fy = fya[5]) AS "year5_Income_GBP_m",\n            MAX(spending_m) FILTER (WHERE fy = fya[5]) AS "year5_Spending_GBP_m",\n            MAX(net_assets_m) FILTER (WHERE fy = fya[5]) AS "year5_Net_Assets_GBP_m",\n            MAX(employees) FILTER (WHERE fy = fya[5]) AS "year5_Employees",\n            \n            -- Funder location/regulator details \n            MAX(fd.charity_number) AS charity_number,\n            MAX(fd.active::text) AS active, \n            MAX(fd.date_of_registration) AS date_of_registration,\n            MAX(fd.how::text) AS how,  \n            MAX(fd.what::text) AS what, \n            MAX(fd.who::text) AS who,\n            MAX(fd.scale::text) AS scale,\n\n            -- HQ Location Codes and Names\n            MAX(fd.la_hq::text) AS la_hq,\n            MAX(fd.la_hq_name::text) AS la_hq_name,\n            MAX(fd.rgn_hq::text) AS rgn_hq,\n            MAX(fd.rgn_hq_name::text) AS rgn_hq_name, \n            MAX(fd.ctry_hq::text) AS ctry_hq,\n            MAX(fd.ctry_hq_name::text) AS ctry_hq_name,\n\n            -- AOO Location Codes and Names\n            MAX(fd.la_aoo::text) AS la_aoo,\n            MAX(fd.la_aoo_name::text) AS la_aoo_name,\n            MAX(fd.rgn_aoo::text) AS rgn_aoo,\n            MAX(fd.rgn_aoo_name::text) AS rgn_aoo_name,  \n            MAX(fd.ctry_aoo::text) AS ctry_aoo,\n            MAX(fd.ctry_aoo_name::text) AS ctry_aoo_name,  \n            MAX(fd.overseas_aoo::text) AS overseas_aoo,\n            MAX(fd.overseas_aoo_name::text) AS overseas_aoo_name,  \n            \n            MAX(fd.london_aoo::text) AS london_aoo, \n            MAX(fd.london_hq::text) AS london_hq,  \n            \n            -- check for 2 years of data (last 2 years) \n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending_grant_making IS NOT NULL) = 2) AS "has_2yrs_Grantmaking",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending_grant_making_individuals IS NOT NULL) = 2) AS "has_2yrs_Grantmaking_Individuals",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND income IS NOT NULL) = 2) AS "has_2yrs_Income",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND spending IS NOT NULL) = 2) AS "has_2yrs_Spending",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND total_net_assets IS NOT NULL) = 2) AS "has_2yrs_Net_Assets",\n            (COUNT(*) FILTER (WHERE fy IN (fya[1], fya[2]) AND employees IS NOT NULL) = 2) AS "has_2yrs_Employees",\n            \n            (CASE\n            WHEN MAX(income) FILTER (WHERE fy = fya[1]) IS NULL \n            AND MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) IS NULL \n            THEN 0\n\n            WHEN MAX(income) FILTER (WHERE fy = fya[1]) < 5000 \n            AND MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) < 5000 \n            THEN 0\n\n            ELSE 1\n            END) > 0 AS "include_in_analysis",\n            ufv.makes_grants_to_individuals\n        FROM\n            ufv\n        LEFT JOIN funder_details fd ON ufv.org_id = fd.org_id,\n            financial_years\n        GROUP BY\n            ufv.segment,\n            ufv.category,\n            ufv.org_id,\n            ufv.name,\n            ufv.makes_grants_to_individuals\n        ORDER BY \n            MAX(spending_grant_making) FILTER (WHERE fy = fya[1]) DESC NULLS LAST', 'ukgrantmaking_funders_analysis_view', engine='django.db.backends.postgresql'),
            atomic=False,
        ),
    ]
